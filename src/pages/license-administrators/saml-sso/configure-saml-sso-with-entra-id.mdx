import { Callout } from "nextra/components";
import Image from 'next/image';

# Configure SAML SSO with Microsoft Entra ID

This guide walks you through configuring SAML Single Sign-On for Bruno using Microsoft Entra ID (formerly Azure Active Directory) as your identity provider.

<Callout type="info">
Before you begin, make sure you have completed the [prerequisites](./overview#prerequisites) and have admin access to both Microsoft Entra ID and the Bruno License Portal.
</Callout>

## Configure SSO in Bruno

Before configuring a SAML application in Microsoft Entra ID, first configure SSO in Bruno.

1. Log in to the [Bruno License Portal](https://license.usebruno.com/)
2. Navigate to **Settings** → **SSO** in the left sidebar

<Image src="/screenshots/sso-scim-management/saml-sso/bruno-sso-settings.webp" alt="Bruno SSO Configuration settings page" width={800} height={200} className="rounded mt-4" />

3. Toggle the **Enable SSO** switch on

4. Note the following values (you'll need these when configuring Entra ID):
   - **SAML ACS URL**: Copy this URL exactly as shown in Bruno
   - **SP Issuer ID / Entity ID**: Set your own unique identifier (e.g., `bruno-sso`, `bruno-entra`, `your-company-bruno`, etc.)

<Image src="/screenshots/sso-scim-management/entra/entra-sso-0.webp" alt="Bruno SSO Configuration settings page" width={800} height={200} className="rounded mt-4" />

<Callout type="info">
Keep this page open in a separate tab - you'll return here after configuring Entra ID to complete the Bruno SSO setup.
</Callout>

## Configure SSO with Microsoft Entra ID

### Step 1: Create a New Enterprise Application

1. Log in to the [Microsoft Entra admin center](https://entra.microsoft.com/)
2. On the left sidebar, navigate to **Enterprise apps** → **+ New application**
3. Click **Create your own application**
4. Enter the application name: Set your own unique identifier (e.g.,`Bruno`, `Bruno-SAML-App`, etc.)
5. Select **Integrate any other application you don't find in the gallery (Non-gallery)**
6. Click **Create**

<Image src="/screenshots/sso-scim-management/entra/entra-sso-1.webp" alt="Select SAML as single sign-on method in Entra ID" width={800} height={600} className="rounded mt-4" />

### Step 2: Select SAML as Single Sign-On Method

1. In the created Enterprise Application, navigate to **Manage** → **Single sign-on** in the left sidebar
2. Select **SAML** as the single sign-on method

<Image src="/screenshots/sso-scim-management/entra/entra-sso-2.webp" alt="Select SAML as single sign-on method in Entra ID" width={800} height={600} className="rounded mt-4" />

### Step 3: Configure Basic SAML Configuration

1. Under **Single sign-on** section in the **Basic SAML Configuration** section, click **Edit**
2. Copy the values from the Bruno SSO settings page and paste them into your SAML configuration in Microsoft Entra ID:
   - **Identifier (Entity ID)**: Paste the **SP Issuer ID / Entity ID** value from the Bruno License Portal
   - **Reply URL (Assertion Consumer Service URL)**: copy and paste the **SAML ACS URL** from the Bruno License Port
3. Click **Save**

<Image src="/screenshots/sso-scim-management/entra/entra-sso-3.webp" alt="Configure basic SAML settings in Entra ID" width={800} height={600} className="rounded mt-4" />

<Callout type="warning">
**Critical**: The Entity ID in Entra ID must match EXACTLY what you configured in Bruno's **SP Issuer ID / Entity ID** field. A mismatch will cause authentication failures.
</Callout>

### Step 4: Configure Attributes & Claims

Bruno requires three specific SAML attributes to be configured in Entra ID:
- `Unique User Identifier (Name ID)`, `roles` and `fullName`). 

These attributes map user information from Entra ID to your Bruno subscription, ensuring users get the correct access levels.

**How Attribute Mapping Works:**
- **User Identification**: Bruno uses the email address (NameID) to match the SSO user with existing Bruno users in your subscription
- **Role Assignment**: The `roles` attribute determines whether the user gets admin or standard access in Bruno
- **Profile Information**: The `fullName` attribute populates the user's display name in Bruno

#### Required Claims

In the **Attributes & Claims** section:

1. Click **Edit**

<Image src="/screenshots/sso-scim-management/entra/entra-sso-5.webp" alt="Configure attributes and claims in Entra ID" width={800} height={600} className="rounded mt-4" />

2. Delete any existing claims that are not on this list
3. You will now update the claims to match the following:

| Claim Name | Source Attribute | Notes |
|------------|------------------|-------|
| **Unique User Identifier (Name ID)** | `user.mail` | Required for user identification. |
| **roles** | Static value, user attribute, or transformation - e.g., `user.assignedroles`, `user.department`, `user.jobtitle`, etc. | Any role value from Entra ID. Can be mapped to existing user attributes or group membership. |
| **fullName** | Transformation: `user.givenname + " " + user.surname` or equivalent attribute | Represents the combined user's first and last name. |

#### Configuring the `Unique User Identifier (Name ID)` claim

This claim is required for user identification. It will be mapped to the user's email address in Entra ID.

2. Click the `Unique User Identifier` claim
3. Select the **Source Attribute** option
4. Choose `user.mail` as the attribute
5. Click **Save**

<Image src="/screenshots/sso-scim-management/entra/entra-sso-6.webp" alt="Configure unique user identifier in Entra ID" width={800} height={600} className="rounded mt-4" />

#### Configuring the `roles` claim

The `roles` claim will represent the user's roles in Bruno. This role value will be mapped to Bruno access levels for the License Portal and for License Activation.

On the **Attributes & Claims** page:

1. Click **Add new claim**
2. Enter `roles` as the name
3. Configure the claim as follows:

   - Map to existing user attribute**:
     - Under **Source**, select **Attribute**
     - Choose an existing user attribute like `user.assignedroles`, `user.department`, `user.jobtitle`, or custom attributes
4. Click **Save**

<Image src="/screenshots/sso-scim-management/entra/entra-sso-7.webp" alt="Configure roles claim in Entra ID" width={800} height={600} className="rounded mt-4" />


**Important**: The role value sent by Entra ID will be mapped to Bruno access levels in the License Portal's SSO Settings. You'll configure which role values correspond to admin or user access in Bruno (see Step 2 in the Bruno configuration section below).

**Example Scenarios:**
- If you set a static value of `Engineering`, you'll add the value `Engineering` in the Bruno License Portal to the corrsponding Admin or User role field
- If you map to `user.department` and a user's department is `IT`, you'll add `IT` to the appropriate role field in the Bruno License Portal 


#### Configuring the `fullName` claim 

The `fullName` claim represents the user's full name. This may already be available in your Entra ID user profile as a single field (e.g., `user.displayname`). If so, you can map the `fullName` attribute directly to that field.

If a full name field is not available, you can concatenate the first and last name fields using a transformation as follows:

On the **Attributes & Claims** page:

1. Click **Add new claim**
2. Enter `fullName` as the name
3. Under **Source**, select **Transformation**
4. In **Manage Transformation**, configure the transformation:
   - **Trasformation**: `Join()`
   - **Parameter 1**: `user.givenname`
   - **Separator**: ` ` (space)
   - **Parameter 2**: `user.surname`
6. Click **Save**

<Image src="/screenshots/sso-scim-management/entra/entra-sso-8.webp" alt="Configure fullName claim in Entra ID" width={800} height={600} className="rounded mt-4" />

#### Finalized Attributes & Claims Configuration

Return to the **Attributes & Claims** page and verify the following:

1. Any other claims that are not on shown below have been deleted
2. The `Unique User Identifier (Name ID)`, `roles` and `fullName` claims are configured as shown shown above

<Image src="/screenshots/sso-scim-management/entra/entra-sso-9.webp" alt="Finalized attributes and claims configuration in Entra ID" width={800} height={600} className="rounded mt-4" />

<Callout type="warning">
**Important**: Both `roles` and `fullName` attributes are required for Bruno SAML SSO to function correctly. The attribute names are case-sensitive and must match the appropriate values configured in Entra ID.
</Callout>

{/* TODO: Add screenshot - entra-attributes-claims.png
     Shows the Attributes & Claims configuration
     Alt text: "Configure attributes and claims in Entra ID" */}

## Finish SSO Configuration

### Step 5: Download SAML Certificate and Copy Metadata

Return to the Enterprise Application page and navigate to **Manage** → **Single sign-on** in the left sidebar

1. In the **SAML Certificates** section:
   - **Certificate (Base64)**: Download the certificate

2. In the **Set up Bruno** section, copy the following values (you'll need these for Bruno configuration):
   - **Login URL**: Copy this URL

{/* TODO: Add screenshot - entra-saml-metadata.png
     Shows the SAML Certificates and Set up Bruno sections

### Step 6: Assign Users or Groups

1. Navigate to **Manage** → **Users and groups** in the left sidebar
2. Click **Add user/group**
3. Select the users or groups that should have access to Bruno
4. Click **Assign**

{/* TODO: Add screenshot - entra-assign-users.png
     Shows the Users and groups assignment page
     Alt text: "Assign users or groups to Bruno app in Entra ID" */}

## Complete SSO Configuration in Bruno

Now that Entra ID is configured, return to Bruno to complete the SSO setup.

### Step 1: Enter Identity Provider Details

1. Return to the Bruno License Portal tab you kept open earlier
2. Navigate to **Settings** → **SSO** (if not already there)
3. Enter the following information from Entra ID:
   - **IdP Login URL**: Paste the **Login URL** from Entra ID
   - **IdP Entity ID**: Paste the **Microsoft Entra Identifier** from Entra ID
   - **IdP Certificate**: Open the downloaded certificate file and paste the contents (include the `-----BEGIN CERTIFICATE-----` and `-----END CERTIFICATE-----` lines)

{/* TODO: Add screenshot - bruno-saml-config-entra.png
     Shows the Bruno SAML SSO configuration page with Entra ID values
     Alt text: "Configure SAML SSO in Bruno License Portal for Entra ID" */}

### Step 2: Configure Role Mapping

Map the role values from Entra ID to Bruno access levels:

1. **Admin Roles**: Enter the role values (comma-separated) that should have admin access to Bruno
   - Example: `admin,IT,BrunoAdministrators`
   - These values must match what you configured in the `roles` claim in Entra ID
   - Users with these roles can access the admin panel and manage licenses

2. **User Roles**: Enter the role values (comma-separated) that should have user access to Bruno
   - Example: `user,Engineering,Developers,QA`
   - These values must match what you configured in the `roles` claim in Entra ID
   - Users with these roles have standard access to Bruno

<Callout type="info">
**How Role Mapping Works:**

The role value you configured in Entra ID's `roles` claim will be sent in the SAML assertion. Bruno will check if this value matches any role in the "Admin Roles" or "User Roles" fields.

**Example:**
- In Entra ID, you set the `roles` claim to map to `user.department`
- A user's department is `Engineering`
- In Bruno Admin Roles, you enter: `admin,IT`
- In Bruno User Roles, you enter: `user,Engineering,QA`
- Result: Users from the Engineering department get standard access (matches "Engineering" in User Roles)
</Callout>

<Callout type="warning">
**Important**: Role values are case-sensitive. Ensure the values in Entra ID's `roles` claim match exactly with the values you enter in Bruno's Admin Roles or User Roles fields.
</Callout>

### Step 3: Configure Session Settings

1. **Session Timeout**: Set the session timeout in seconds (default: 3600 = 1 hour)
2. Click **Save** to apply your SAML SSO configuration

{/* TODO: Add screenshot - bruno-role-mapping-entra.png
     Shows the role mapping configuration in Bruno with Group Object IDs
     Alt text: "Configure role mapping in Bruno License Portal for Entra ID" */}

## Test Your SAML Configuration

You can test your SAML configuration by creating a test user in Microsoft Entra ID and assigning them the Bruno app.

1. In the Bruno SAML SSO settings, click **Test SSO Connection**
2. You should be redirected to Microsoft Entra ID to authenticate
3. After successful authentication, you should be redirected back to Bruno
4. Verify that your user information and roles are correctly displayed

{/* TODO: Add screenshot - bruno-test-sso-entra.png
     Shows the test SSO connection button and success message
     Alt text: "Test SSO connection in Bruno for Entra ID" */}

<Callout type="info">
If you encounter any issues, confirm you've added and saved the correct configuration values on both Bruno and Microsoft Entra ID. See the [Troubleshooting Guide](./troubleshooting) for help.
</Callout>

## Next Steps

After setting up SSO with Microsoft Entra ID, you can:

- [Configure SCIM Provisioning](../scim-provisioning/overview) to automate user provisioning and deprovisioning
- [Manage your Bruno licenses](../license-portal) in the License Portal
- Review the [Troubleshooting Guide](./troubleshooting) for common SSO issues
